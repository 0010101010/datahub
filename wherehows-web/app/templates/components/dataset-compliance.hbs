<div id="compliance" class="tab-body">
  {{#if _hasBadData}}
    <div class="alert alert-danger post-action-notification" role="alert">
      <p>
        Oops! We have discovered some issues with this Dataset's fields that
        may put any updates in an invalid state. <br/>
        Unfortunately updates are <strong>disabled</strong> at this time. <br/>
        Please shoot us an email at
        <a href="mailto:ask_metadata@linkedin.com">ask_metadata@linkedin.com</a>
        and we will get on this asap! <br/>
        Our apologies.
      </p>
    </div>
  {{else}}
    <section class="action-bar">
      {{#if isEditing}}
        <div class="container action-bar__content">
          <button
            class="nacho-button nacho-button--large-inverse action-bar__item"
            title={{unless isDatasetFullyClassified
                           "Ensure you have provided a yes/no value for all dataset tags"
                           "Save"}}
              disabled={{isSavingDisabled}}
            {{action "saveCompliance"}}>
            Save
          </button>

          <button class="nacho-button nacho-button--large action-bar__item"
            {{action "resetCompliance"}}>
            <i class="fa fa-times" title="Cancel">
            </i>
            Cancel
          </button>

          {{#if _message}}
            <div class="alert alert-{{_alertType}} post-action-notification action-footer-notification" role="alert">
              {{_message}}
            </div>
          {{/if}}
        </div>
      {{/if}}
    </section>
  {{/if}}

  <div class="secondary-actions">
    <div class="policy-last-saved">
      Last saved:
      <span class="policy-last-saved__saved">
        {{if isNewComplianceInfo 'Never'
             (moment-from-now policyModificationTimeInEpoch)}}
      </span>
    </div>

    {{#unless isEditing}}
      <button
        {{action "onEdit"}}
        class="nacho-button--large nacho-button--secondary secondary-actions__action">
        Edit
      </button>

      {{#unless isNewComplianceInfo}}
        <button
          {{action "onComplianceDownloadJson"}}
          class="nacho-button nacho-button--large-inverse secondary-actions__action">
          Download compliance metadata
        </button>
      {{/unless}}
    {{/unless}}
  </div>

  {{#if (and isEditing (not _hasBadData))}}
    {{json-upload receiveJsonFile=(action "onComplianceJsonUpload") class="secondary-actions__action"}}
  {{/if}}

  <section class="metadata-prompt">
    <header class="metadata-prompt__header">
      <p>
        {{if isEditing
             "Does this dataset contain the following types of Member data?"
             "Types of member data contained in this dataset"}}

        <!--TODO: DSS-6716-->
        <!-- DRY out with wrapper component that takes the link as an attribute-->
        <a
          target="_blank"
          href="http://go/gdpr-taxonomy#MetadataTaxonomyforDataSets-DatasetLevelTags">
          <sup>
            More Info

            <span class="glyphicon glyphicon-question-sign"
                  title="More information on Dataset classification with examples"></span>
          </sup>
        </a>
      </p>

      {{#if isEditing}}
        <button
          {{action "markDatasetAsNotContainingMemberData"}}
          class="nacho-button--large nacho-button--secondary mark-dataset-no-button">
          Mark all as No
        </button>
      {{/if}}
    </header>
  </section>

  {{#dataset-table
    class="nacho-table nacho-table--bordered nacho-table--stripped"
    fields=datasetClassification as |table|}}

    {{#table.head as |head|}}
      {{#head.column}}Types of member data{{/head.column}}

      {{#head.column class="dataset-field-content__header"}}
        <span class="dataset-field-value">Is this type of member data contained in this dataset?</span>
      {{/head.column}}
    {{/table.head}}

    {{#table.body as |body|}}
      {{#each (if isShowingAllMemberData table.data (filter-by "value" true table.data)) as |classification|}}
        {{#body.row as |row|}}
          {{#row.cell class="dataset-field-content__prompt"}}
            <span class="dataset-tag-container">
            {{#if (eq classification.value true)}}

              <i class="dataset-classification-indicator dataset-classification-indicator--tagged"
                 title="{{classification.label}} is in dataset">
                <svg viewBox="0 0 24 24" width="24px" height="24px" x="0" y="0" preserveAspectRatio="xMinYMin meet">
                  <g class="large-icon" style="fill: currentColor">
                    <path
                      d="M19.68,4L9,17.7,4.36,12,3,13.06l5.42,6.67A0.72,0.72,0,0,0,9,20a0.7,0.7,0,0,0,.59-0.28L21,5.05Z"></path>
                  </g>
                </svg>
              </i>

            {{/if}}

              {{#if (eq classification.value false)}}
                <i class="dataset-classification-indicator dataset-classification-indicator--not-tagged"
                   title="{{classification.label}} is not in dataset">
                <svg viewBox="0 0 24 24" width="24px" height="24px" x="0" y="0" preserveAspectRatio="xMinYMin meet">
                  <g class="large-icon" style="fill: currentColor">
                    <path
                      d="M20,5.32L13.32,12,20,18.68,18.66,20,12,13.33,5.34,20,4,18.68,10.68,12,4,5.32,5.32,4,12,10.69,18.68,4Z"></path>
                  </g>
                </svg>
              </i>
              {{/if}}

              {{classification.label}}
          </span>
          {{/row.cell}}

          {{#row.cell class="dataset-field-content__input"}}
            <span class="dataset-field-value">
            {{#radio-button-composer
              value=true
              name=classification.classifier
              groupValue=(readonly classification.value)
              changed=(action "onChangeDatasetClassification")}}
              Yes
            {{/radio-button-composer}}
              {{#radio-button-composer
                value=false
                name=classification.classifier
                groupValue=(readonly classification.value)
                changed=(action "onChangeDatasetClassification")}}
                No
              {{/radio-button-composer}}
          </span>{{/row.cell}}
        {{/body.row}}
      {{/each}}
    {{/table.body}}

    {{#unless isShowingAllMemberData}}
      {{#table.foot}}
        <td colspan="2" class="text-center">
          <button
            {{action "onShowAllDatasetMemberData"}}
            class="nacho-button--large nacho-button--tertiary">
            See More <span class="caret" aria-label="See More Dataset Member Data"></span>
          </button>
        </td>
      {{/table.foot}}
    {{/unless}}

  {{/dataset-table}}

  <section class="metadata-prompt">
    <header class="metadata-prompt__header">
      <p>
        {{if isEditing "Do fields in the schema contain the ID of a member (e.g. id, urn,
        etcetera) and what are the formats of the fields in the schema?" "Field formats in the schema"}}
        <a
          target="_blank"
          href="http://go/gdpr-taxonomy#MetadataTaxonomyforDataSets-Field-levelDataTypelists">
          <sup>
            More Info

            <span class="glyphicon glyphicon-question-sign"
                  title="More information on Schema field format and types"></span>
          </sup>
        </a>
      </p>
    </header>
    {{!--Renders content of `hiddenTrackingFields` to the viewer if the dataset contains hidden tracking fields--}}
    {{#if containsHiddenTrackingFields}}
      {{hiddenTrackingFields}}
    {{/if}}
  </section>

  {{#if mergedComplianceEntitiesAndColumnFields.length}}
    {{#dataset-table
      class="nacho-table--stripped dataset-compliance-fields"
      fields=mergedComplianceEntitiesAndColumnFields
      sortColumnWithName=sortColumnWithName
      filterBy=filterBy
      sortDirection=sortDirection
      tableRowComponent='dataset-compliance-row'
      searchTerm=searchTerm as |table|}}

      <caption>
        <input
          type="text"
          title="Search fields"
          placeholder="Search fields"
          value="{{table.searchTerm}}"
          oninput={{action table.filterDidChange value="target.value"}}>

        {{#if hasRecentSuggestions}}
          <span class="dataset-compliance-fields__has-suggestions">
            {{complianceSuggestion.complianceSuggestions.length}} fields to be reviewed
          </span>
        {{/if}}
      </caption>

      {{#table.head as |head|}}
        {{#head.column class="dataset-compliance-fields__notification-column"}}{{/head.column}}
        {{#head.column columnName="identifierField"}}Field{{/head.column}}
        {{#head.column columnName="dataType"}}Data Type{{/head.column}}
        {{#head.column class="nacho-table-cell-wrapped" columnName="confidence"}}
          System Suggestion Confidence
        {{/head.column}}
        {{#head.column class="nacho-table-cell-wrapped"}}
          Member, Organization, or Group, ID's
          <a
            target="_blank"
            href="http://go/metadata_acquisition#ProjectOverview-compliance">
            <sup>
              More Info

              <span class="glyphicon glyphicon-question-sign"
                    title="More information on various IDs"></span>
            </sup>
          </a>
        {{/head.column}}
        {{#head.column}}
          Field Format?
          <a
            target="_blank"
            href="http://go/gdpr-taxonomy#MetadataTaxonomyforDataSets-DatasetLevelTags">
            <sup>
              More Info

              <span class="glyphicon glyphicon-question-sign"
                    title="More information on Field Format"></span>
            </sup>
          </a>
        {{/head.column}}
        {{#head.column}}
          Security Classification
          <sup>
          <span
            class="glyphicon glyphicon-question-sign"
            title={{helpText.classification}}>
            {{tooltip-on-component
              event="click"
              hideOn="click"
              text=helpText.classification
            }}
          </span>
          </sup>
        {{/head.column}}
      {{/table.head}}

      {{#table.body as |body|}}
        {{#each (sort-by table.sortBy table.data) as |field|}}
          {{#body.row
            field=field
            class=(if (and hasRecentSuggestions field.suggestion) "dataset-compliance-fields__has-suggestions")
            hasRecentSuggestions=hasRecentSuggestions
            onFieldLogicalTypeChange=(action 'onFieldLogicalTypeChange')
            onFieldClassificationChange=(action 'onFieldClassificationChange')
            onSuggestionIntent=(action 'onFieldSuggestionIntentChange')
            onFieldIdentifierTypeChange=(action 'onFieldIdentifierTypeChange')as |row|}}

            {{#row.cell}}
              {{#if row.suggestion}}
                <span class="notification-dot notification-dot--has-prediction"
                      aria-label="Compliance fields have suggested values"></span>
              {{/if}}

              {{#if isNewComplianceInfo}}
                <span class="notification-dot notification-dot--is-unsaved"
                      aria-label="Compliance has not been saved"></span>
              {{/if}}
            {{/row.cell}}

            {{#row.cell}}
              {{row.identifierField}}
            {{/row.cell}}

            {{#row.cell}}
              {{row.dataType}}
            {{/row.cell}}

            {{#row.cell}}
              {{#if row.suggestion}}
                {{row.suggestion.confidence}}%
                {{#if isEditing}}
                  {{auto-suggest-action type="accept" action=(action row.onSuggestionAction)}}
                  {{auto-suggest-action action=(action row.onSuggestionAction)}}
                {{/if}}
              {{else}}
                {{#if row.suggestionAuthority}}
                  {{capitalize row.suggestionResolution}}
                {{else}}
                  &mdash;
                {{/if}}
              {{/if}}
            {{/row.cell}}

            {{#row.cell}}
              {{ember-selector
                disabled=(not isEditing)
                values=fieldIdentifierOptions
                selected=(readonly row.identifierType)
                selectionDidChange=(action row.onFieldIdentifierTypeChange)
              }}
            {{/row.cell}}

            {{#row.cell}}
              {{#power-select
                options=row.fieldFormats
                selected=row.logicalType
                disabled=(or row.isFieldFormatDisabled (not isEditing))
                placeholder="Select Format"
                allowClear=true
                searchField="label"
                triggerClass="ember-power-select-trigger-search"
                onchange=(action row.onFieldLogicalTypeChange) as |fieldFormat|}}
                {{fieldFormat.label}}
              {{/power-select}}
            {{/row.cell}}

            {{#row.cell}}
              {{ember-selector
                class="nacho-select--hidden-state"
                values=classifiers
                selected=row.classification
                disabled=(or (not isEditing) (not row.logicalType))
                selectionDidChange=(action row.onFieldClassificationChange)
              }}
            {{/row.cell}}
          {{/body.row}}
        {{/each}}
      {{/table.body}}

    {{/dataset-table}}
  {{/if}}
</div>

{{yield}}
